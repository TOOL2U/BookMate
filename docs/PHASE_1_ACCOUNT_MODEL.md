# Phase 1 - Step 1: Account Config Model Implementation

‚úÖ **COMPLETE** - Firestore account configuration model with TypeScript abstraction layer

## üìã Overview

This implementation provides a clean, type-safe Firestore data model for managing BookMate account configurations. Each account represents one company with its own Google Sheet spreadsheet and Apps Script instance.

---

## üóÑÔ∏è Firestore Structure

### Collection: `accounts`

Each document in the `accounts` collection represents one BookMate account.

**Document Structure:**
```typescript
{
  // Auto-generated by Firestore
  id: "abc123xyz",
  
  // Human-readable identifier
  accountId: "shaun-property-management",
  
  // Company information
  companyName: "Shaun's Property Management",
  
  // User association
  userEmail: "shaun@example.com",
  
  // Google Sheets configuration
  sheetId: "1UnCopzurl27VRqVDSIgrro5KyAfuP9T0GRePrtljAR8",
  
  // Apps Script configuration (unique per account)
  scriptUrl: "https://script.google.com/macros/s/AKfycbw.../exec",
  scriptSecret: "secret_abc123_unique_per_account",
  
  // Metadata
  createdAt: Timestamp(2025-11-14T10:30:00Z),
  createdBy: "firebase-uid-of-admin",
  status: "active", // "active" | "suspended" | "archived"
  
  // Optional update tracking
  updatedAt: Timestamp(2025-11-14T15:45:00Z),
  updatedBy: "firebase-uid-of-admin"
}
```

### Indexes Required

While single-field queries work without custom indexes, you may want to create composite indexes for:

```javascript
// Recommended indexes for better query performance:
accounts: {
  userEmail: "asc",
  status: "asc"
}

accounts: {
  accountId: "asc",
  status: "asc"
}
```

---

## üì¶ TypeScript Types

### Location: `lib/types/account.ts`

#### 1. `AccountConfig` (Full Document)
The complete account configuration as stored in Firestore.

```typescript
interface AccountConfig {
  id: string;                  // Firestore doc ID
  accountId: string;           // Human-readable ID
  companyName: string;         // Company name
  userEmail: string;           // Primary user email
  sheetId: string;             // Google Sheets ID
  scriptUrl: string;           // Apps Script WebApp URL
  scriptSecret: string;        // Apps Script auth secret
  createdAt: Timestamp;        // Server timestamp
  createdBy: string;           // Admin UID
  status?: 'active' | 'suspended' | 'archived';
  updatedAt?: Timestamp;       // Optional update time
  updatedBy?: string;          // Optional updater UID
}
```

#### 2. `CreateAccountInput` (Creation Input)
Data required to create a new account (excludes auto-generated fields).

```typescript
interface CreateAccountInput {
  accountId: string;
  companyName: string;
  userEmail: string;
  sheetId: string;
  scriptUrl: string;
  scriptSecret: string;
  createdBy: string;           // Admin UID creating the account
  status?: 'active' | 'suspended' | 'archived';
}
```

#### 3. `UpdateAccountInput` (Update Input)
Partial update data (all fields optional except `updatedBy`).

```typescript
interface UpdateAccountInput {
  companyName?: string;
  userEmail?: string;
  sheetId?: string;
  scriptUrl?: string;
  scriptSecret?: string;
  status?: 'active' | 'suspended' | 'archived';
  updatedBy: string;           // Admin UID performing update
}
```

#### 4. `AccountConfigSerialized` (Client-Safe)
Version with Timestamps converted to ISO strings for client-side use.

```typescript
interface AccountConfigSerialized {
  // Same as AccountConfig but:
  createdAt: string;           // ISO string instead of Timestamp
  updatedAt?: string;          // ISO string instead of Timestamp
}
```

---

## üõ†Ô∏è Helper Functions

### Location: `lib/accounts.ts`

All functions use **Firebase Admin SDK** (server-side only).

### 1. Create Account

```typescript
async function createAccount(
  input: CreateAccountInput
): Promise<AccountConfig>
```

**Features:**
- ‚úÖ Validates `accountId` is unique
- ‚úÖ Validates `userEmail` doesn't already have an account
- ‚úÖ Auto-generates Firestore document ID
- ‚úÖ Uses `serverTimestamp()` for accurate timestamps
- ‚ùå Throws error if duplicates found

**Example:**
```typescript
const newAccount = await createAccount({
  accountId: 'tommy-rentals',
  companyName: 'Tommy Rental Properties',
  userEmail: 'tommy@example.com',
  sheetId: '1ABC...XYZ',
  scriptUrl: 'https://script.google.com/macros/s/AKfycbw.../exec',
  scriptSecret: 'secret_tommy_unique',
  createdBy: adminUser.uid, // From Firebase Auth
});
```

---

### 2. Get Account by Email

```typescript
async function getAccountByEmail(
  userEmail: string
): Promise<AccountConfig | null>
```

**Use Case:** Lookup account when user logs in.

**Example:**
```typescript
const account = await getAccountByEmail('shaun@example.com');
if (account) {
  console.log(`Found account: ${account.companyName}`);
  console.log(`Spreadsheet ID: ${account.sheetId}`);
}
```

---

### 3. Get Account by ID

```typescript
async function getAccountById(
  accountId: string
): Promise<AccountConfig | null>
```

**Use Case:** Fetch account by human-readable identifier.

**Example:**
```typescript
const account = await getAccountById('shaun-property-management');
```

---

### 4. Get Account by Document ID

```typescript
async function getAccountByDocId(
  docId: string
): Promise<AccountConfig | null>
```

**Use Case:** Direct Firestore document lookup (rarely used).

---

### 5. Get All Accounts (Admin Only)

```typescript
async function getAllAccounts(): Promise<AccountConfig[]>
```

**Use Case:** Admin dashboard to list all accounts.

**Example:**
```typescript
const allAccounts = await getAllAccounts();
console.log(`Total accounts: ${allAccounts.length}`);
```

---

### 6. Update Account

```typescript
async function updateAccount(
  accountId: string,
  input: UpdateAccountInput
): Promise<AccountConfig>
```

**Features:**
- ‚úÖ Partial updates (only changed fields)
- ‚úÖ Auto-updates `updatedAt` timestamp
- ‚úÖ Tracks who made the update via `updatedBy`

**Example:**
```typescript
const updated = await updateAccount('tommy-rentals', {
  scriptUrl: 'https://script.google.com/macros/s/NEW_URL/exec',
  scriptSecret: 'new_secret_123',
  updatedBy: adminUser.uid,
});
```

---

### 7. Delete Account (Soft Delete)

```typescript
async function deleteAccount(
  accountId: string,
  deletedBy: string
): Promise<AccountConfig>
```

**Note:** This is a **soft delete** - sets `status: 'archived'` instead of removing the document.

**Example:**
```typescript
await deleteAccount('old-account', adminUser.uid);
```

---

### 8. Check Account Access

```typescript
async function userHasAccountAccess(
  userEmail: string,
  accountId: string
): Promise<boolean>
```

**Use Case:** Verify user permission before showing data.

**Example:**
```typescript
const hasAccess = await userHasAccountAccess(
  'shaun@example.com',
  'shaun-property-management'
);
```

---

### 9. Serialize for Client

```typescript
function serializeAccountConfig(
  config: AccountConfig
): AccountConfigSerialized
```

**Use Case:** Convert Firestore Timestamps to ISO strings before sending to client.

**Example:**
```typescript
// In API route:
const account = await getAccountByEmail(userEmail);
return NextResponse.json({
  ok: true,
  account: serializeAccountConfig(account),
});
```

---

## üîê Security Model

### Server-Side Only
- ‚ùå **NO client-side access** to `accounts` collection
- ‚úÖ All functions use Firebase **Admin SDK**
- ‚úÖ Should only be called from:
  - API routes (`app/api/**/route.ts`)
  - Server actions
  - Server components

### Firestore Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Accounts collection: Admin read/write only
    match /accounts/{accountId} {
      allow read, write: if false; // Client has NO access
    }
  }
}
```

### Future: Admin Role Check
In production, add admin role verification:

```typescript
import { getAdminAuth } from '@/lib/firebase/admin';

async function requireAdmin(uid: string) {
  const user = await getAdminAuth().getUser(uid);
  const isAdmin = user.customClaims?.admin === true;
  if (!isAdmin) {
    throw new Error('Unauthorized: Admin access required');
  }
}

// Then in createAccount, updateAccount, etc:
await requireAdmin(input.createdBy);
```

---

## üß™ Usage Examples

### Example 1: Admin Creates New Account

```typescript
// app/api/admin/accounts/create/route.ts
import { createAccount } from '@/lib/accounts';
import { getAdminAuth } from '@/lib/firebase/admin';

export async function POST(req: Request) {
  const body = await req.json();
  
  // Verify admin (placeholder - implement proper auth)
  const adminUid = 'admin-uid-from-session';
  
  try {
    const newAccount = await createAccount({
      accountId: body.accountId,
      companyName: body.companyName,
      userEmail: body.userEmail,
      sheetId: body.sheetId,
      scriptUrl: body.scriptUrl,
      scriptSecret: body.scriptSecret,
      createdBy: adminUid,
    });
    
    return NextResponse.json({
      ok: true,
      account: serializeAccountConfig(newAccount),
    });
  } catch (error) {
    return NextResponse.json(
      { ok: false, error: error.message },
      { status: 400 }
    );
  }
}
```

---

### Example 2: User Login ‚Üí Fetch Account Config

```typescript
// app/api/auth/login/route.ts
import { getAccountByEmail } from '@/lib/accounts';

export async function POST(req: Request) {
  const { email, password } = await req.json();
  
  // Authenticate user (Firebase Auth, etc.)
  // ...
  
  // Fetch their account config
  const account = await getAccountByEmail(email);
  
  if (!account) {
    return NextResponse.json(
      { ok: false, error: 'No account found for this user' },
      { status: 404 }
    );
  }
  
  // Store account config in session/context
  return NextResponse.json({
    ok: true,
    account: serializeAccountConfig(account),
  });
}
```

---

### Example 3: Admin Dashboard Lists All Accounts

```typescript
// app/admin/accounts/page.tsx
import { getAllAccounts, serializeAccountConfig } from '@/lib/accounts';

export default async function AdminAccountsPage() {
  const accounts = await getAllAccounts();
  
  return (
    <div>
      <h1>All Accounts ({accounts.length})</h1>
      <table>
        <thead>
          <tr>
            <th>Company</th>
            <th>Email</th>
            <th>Sheet ID</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {accounts.map((account) => (
            <tr key={account.id}>
              <td>{account.companyName}</td>
              <td>{account.userEmail}</td>
              <td>{account.sheetId}</td>
              <td>{account.status || 'active'}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

---

## ‚úÖ Implementation Checklist

- [x] Define Firestore collection structure (`accounts`)
- [x] Create TypeScript types (`AccountConfig`, `CreateAccountInput`, etc.)
- [x] Implement `createAccount()` with duplicate validation
- [x] Implement `getAccountByEmail()`
- [x] Implement `getAccountById()`
- [x] Implement `getAccountByDocId()`
- [x] Implement `getAllAccounts()`
- [x] Implement `updateAccount()` with partial updates
- [x] Implement `deleteAccount()` (soft delete)
- [x] Implement `userHasAccountAccess()` permission check
- [x] Implement `serializeAccountConfig()` for client safety
- [x] Use `serverTimestamp()` for accurate timestamps
- [x] Add proper error handling and logging
- [x] Document all functions and types

---

## üìÅ Files Created

1. **`lib/types/account.ts`** - TypeScript type definitions
2. **`lib/accounts.ts`** - Data access layer with CRUD operations
3. **`docs/PHASE_1_ACCOUNT_MODEL.md`** - This documentation

---

## üöÄ Next Steps (Phase 1 - Step 2)

Now that the data model is ready, the next step is to build the **Admin UI** for creating and managing accounts:

1. Create admin page: `app/admin/accounts/page.tsx`
2. Build form component to input account details
3. Create API route to handle account creation
4. Add validation and error handling
5. Display success/error messages
6. List existing accounts in a table

---

## üìù Notes

- All timestamps use Firestore `serverTimestamp()` for consistency
- Soft delete pattern preserves data history
- Future enhancement: Support multiple users per account
- Future enhancement: Add custom admin role claims
- Future enhancement: Add audit log for all account changes

---

**Status:** ‚úÖ **COMPLETE AND READY FOR ADMIN UI**
