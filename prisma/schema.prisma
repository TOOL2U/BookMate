// BookMate Reports System - Production Database Schema
// Phase 3 - Advanced Reports with Templates, Sharing, and Scheduling

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

// User Accounts - Authentication and profile management
model User {
  id                String    @id @default(uuid())
  firebaseUid       String?   @unique @map("firebase_uid") // Firebase Auth UID
  
  // Profile Information
  email             String    @unique
  emailVerified     Boolean   @default(false) @map("email_verified")
  name              String?
  avatarUrl         String?   @map("avatar_url")
  phone             String?
  
  // Authentication
  passwordHash      String?   @map("password_hash") // For email/password auth
  provider          String    @default("email") // email, google, apple, etc.
  
  // Account Status
  status            String    @default("active") // active, suspended, deleted
  role              String    @default("user") // user, admin, owner
  
  // Workspace & Organization
  workspaceId       String?   @map("workspace_id")
  organizationId    String?   @map("organization_id")
  
  // Google Sheets Integration
  spreadsheetId        String?   @unique @map("spreadsheet_id") // User's personal spreadsheet ID
  spreadsheetUrl       String?   @map("spreadsheet_url")        // Direct link to their sheet
  spreadsheetCreatedAt DateTime? @map("spreadsheet_created_at") // When spreadsheet was created
  
  // Google OAuth Tokens
  googleAccessToken    String?   @map("google_access_token")    // OAuth access token
  googleRefreshToken   String?   @map("google_refresh_token")   // OAuth refresh token
  googleTokenExpiry    DateTime? @map("google_token_expiry")    // Token expiration time
  
  // Security
  lastLoginAt       DateTime? @map("last_login_at")
  lastLoginIp       String?   @map("last_login_ip")
  loginCount        Int       @default(0) @map("login_count")
  failedLoginCount  Int       @default(0) @map("failed_login_count")
  lockedUntil       DateTime? @map("locked_until")
  
  // Preferences
  preferences       Json      @default("{}") // { theme, language, timezone, notifications }
  
  // Metadata
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")
  
  // Relations
  sessions          Session[]
  refreshTokens     RefreshToken[]
  auditLogs         AuditLog[]
  
  // Indexes
  @@index([email])
  @@index([firebaseUid])
  @@index([spreadsheetId])
  @@index([workspaceId])
  @@index([status])
  @@index([role])
  @@map("users")
}

// Session Management - Track active user sessions
model Session {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  
  // Session data
  token           String    @unique // Session token
  deviceInfo      Json?     @map("device_info") // { browser, os, device }
  ipAddress       String?   @map("ip_address")
  userAgent       String?   @map("user_agent")
  
  // Expiry
  expiresAt       DateTime  @map("expires_at")
  lastActivityAt  DateTime  @default(now()) @map("last_activity_at")
  
  // Metadata
  createdAt       DateTime  @default(now()) @map("created_at")
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// Refresh Tokens - JWT refresh token management
model RefreshToken {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  
  // Token data
  token           String    @unique
  deviceId        String?   @map("device_id") // Unique device identifier
  
  // Expiry
  expiresAt       DateTime  @map("expires_at")
  revoked         Boolean   @default(false)
  revokedAt       DateTime? @map("revoked_at")
  
  // Metadata
  createdAt       DateTime  @default(now()) @map("created_at")
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// Audit Log - Track all user actions for security
model AuditLog {
  id              String    @id @default(uuid())
  userId          String?   @map("user_id")
  
  // Action details
  action          String    // login, logout, create, update, delete, etc.
  resource        String?   // users, reports, templates, etc.
  resourceId      String?   @map("resource_id")
  
  // Request data
  ipAddress       String?   @map("ip_address")
  userAgent       String?   @map("user_agent")
  metadata        Json?     // Additional context
  
  // Result
  success         Boolean   @default(true)
  errorMessage    String?   @map("error_message")
  
  // Metadata
  createdAt       DateTime  @default(now()) @map("created_at")
  
  // Relations
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Indexes
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// REPORTS SYSTEM
// ============================================================================

// Report Templates - Reusable report configurations
model ReportTemplate {
  id            String   @id @default(uuid())
  workspaceId   String   @map("workspace_id")
  name          String
  description   String?
  type          String   // internal-summary, investor-update, bank-compliance, custom
  
  // JSONB configuration
  filters       Json     // { dateRange, entities, currency }
  sections      Json     // { kpis, charts, tables, aiSummary }
  branding      Json?    // { logoUrl, primaryColor, footerText }
  
  // Metadata
  isDefault     Boolean  @default(false) @map("is_default")
  createdBy     String?  @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Indexes
  @@index([workspaceId])
  @@index([type])
  @@index([isDefault])
  @@map("report_templates")
}

// Shared Reports - Secure shareable links with access controls
model SharedReport {
  id              String    @id @default(uuid())
  workspaceId     String    @map("workspace_id")
  token           String    @unique
  reportName      String    @map("report_name")
  
  // Report snapshot (frozen data)
  snapshot        Json      // { period, generatedAt, data, pdfUrl, previewUrl }
  
  // Access controls
  expiresAt       DateTime? @map("expires_at")
  passcode        String?   // Hashed passcode
  maxViews        Int?      @map("max_views")
  viewCount       Int       @default(0) @map("view_count")
  
  // Metadata
  createdBy       String?   @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  lastAccessedAt  DateTime? @map("last_accessed_at")

  // Indexes
  @@index([token])
  @@index([workspaceId])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("shared_reports")
}

// Scheduled Reports - Automated report generation and delivery
model ScheduledReport {
  id              String    @id @default(uuid())
  workspaceId     String    @map("workspace_id")
  templateId      String?   @map("template_id")
  
  name            String
  description     String?
  
  // Schedule configuration
  scheduleConfig  Json      @map("schedule_config") // { frequency, dayOfWeek, dayOfMonth, time, timezone }
  
  // Recipients and delivery
  recipients      Json      // [{ email, name }]
  deliveryConfig  Json      @map("delivery_config") // { format, includeAI, emailSubject, customMessage }
  
  // Status and execution tracking
  status          String    @default("active") // active, paused, failed
  nextRun         DateTime? @map("next_run")
  lastRun         DateTime? @map("last_run")
  runCount        Int       @default(0) @map("run_count")
  failureCount    Int       @default(0) @map("failure_count")
  lastError       String?   @map("last_error")
  
  // Metadata
  createdBy       String?   @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Relations
  deliveryLogs    EmailDeliveryLog[]

  // Indexes
  @@index([workspaceId])
  @@index([status])
  @@index([nextRun])
  @@index([createdAt])
  @@map("scheduled_reports")
}

// Email Delivery Logs - Audit trail for all email deliveries
model EmailDeliveryLog {
  id              String    @id @default(uuid())
  workspaceId     String    @map("workspace_id")
  scheduleId      String?   @map("schedule_id")
  
  reportName      String    @map("report_name")
  reportPeriod    String    @map("report_period")
  
  // Recipients
  recipients      Json      // [{ email, name }]
  
  // Delivery details
  emailProvider   String    @default("sendgrid") @map("email_provider") // sendgrid, ses
  messageId       String?   @map("message_id")
  status          String    // sent, failed, bounced, delivered
  error           String?
  
  // PDF details
  pdfSize         Int?      @map("pdf_size") // bytes
  pdfUrl          String?   @map("pdf_url")
  
  // Timestamps
  sentAt          DateTime  @default(now()) @map("sent_at")
  deliveredAt     DateTime? @map("delivered_at")
  
  // Metadata
  userId          String?   @map("user_id")
  metadata        Json?     // Additional metadata
  
  // Relations
  schedule        ScheduledReport? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([workspaceId])
  @@index([scheduleId])
  @@index([status])
  @@index([sentAt])
  @@map("email_delivery_logs")
}

// Report Generation Jobs - Track async report generation
model ReportJob {
  id              String    @id @default(uuid())
  workspaceId     String    @map("workspace_id")
  
  // Job details
  type            String    // generate, pdf, share, email
  status          String    @default("pending") // pending, processing, completed, failed
  progress        Int       @default(0) // 0-100
  
  // Input configuration
  config          Json      // Report configuration
  
  // Output
  result          Json?     // Generated report data or error
  
  // Execution details
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  duration        Int?      // milliseconds
  error           String?
  
  // Metadata
  createdBy       String?   @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  
  // Indexes
  @@index([workspaceId])
  @@index([status])
  @@index([createdAt])
  @@map("report_jobs")
}

// Report Analytics - Track usage and performance
model ReportAnalytics {
  id              String    @id @default(uuid())
  workspaceId     String    @map("workspace_id")
  
  // Event details
  eventType       String    @map("event_type") // generated, exported, shared, scheduled
  reportType      String    @map("report_type") // monthly, quarterly, ytd, custom
  
  // Performance metrics
  generationTime  Int?      @map("generation_time") // milliseconds
  aiTokensUsed    Int?      @map("ai_tokens_used")
  pdfSize         Int?      @map("pdf_size") // bytes
  
  // User context
  userId          String?   @map("user_id")
  templateId      String?   @map("template_id")
  
  // Timestamp
  timestamp       DateTime  @default(now())
  
  // Metadata
  metadata        Json?

  // Indexes
  @@index([workspaceId])
  @@index([eventType])
  @@index([timestamp])
  @@map("report_analytics")
}
